// =========================================================
// DanceInviteButton.lsl - Invite guests to the dance ball
// =========================================================
//
// Put this script directly into the HUD "Invite" button prim.
// When the HUD owner clicks the button:
//
//  - Scans for avatars within 100m of the host.
//  - Shows a paged dialog (blue menu) listing their names.
//    Button labels are short and always <= 24 characters.
//  - Always includes an "Everyone" option and "Cancel".
//  - If there are more names than fit on one page, a "More >>"
//    button appears to go to the next page.
//
// When a name (or Everyone) is chosen, it sends this message:
//
//   "Touch the dance ball nearby Display Name (legacy.name)
//    to dance with them."
//
// "Mentioning the user" in messages uses Display Name with
// (legacy.name) format. Buttons use a truncated label to respect
// the 24-character dialog button limit.
//
// No ?:, no continue; paging supported.
// =========================================================

integer INVITE_RANGE_METERS = 100;

integer MENU_CHANNEL   = 0;
integer MENU_HANDLE    = -1;
integer MENU_ACTIVE    = FALSE;

integer NAMES_PER_PAGE = 8;   // leave room for Everyone, More >>, Cancel

list    gAvKeys        = [];
list    gAvNames       = [];  // short button labels (<=24 chars)
list    gAvFullNames   = [];  // full "Display (legacy)" used in chat
integer gCurrentPage   = 0;

key     gHost          = NULL_KEY;
string  gHostName      = "";

// ---------------- Helpers ----------------

integer Debug(string msg)
{
    // Set to TRUE if you want chat spam for debugging
    integer debugOn = FALSE;
    if (debugOn && gHost != NULL_KEY)
    {
        llRegionSayTo(gHost, 0, "[INVITE] " + msg);
    }
    return 0;
}

// Full format: "Display Name (legacy.name)" if display != legacy
// Otherwise just "legacy.name"
string FormatName(key av)
{
    string legacy = llKey2Name(av);
    string disp   = llGetDisplayName(av);

    if (legacy == "")
    {
        return disp;
    }

    if (disp == "" || disp == legacy)
    {
        return legacy;
    }

    return disp + " (" + legacy + ")";
}

// Short format for dialog button labels (<= 24 chars)
string FormatNameForButton(key av)
{
    string full = FormatName(av);
    integer maxLen = 24;
    integer len = llStringLength(full);

    if (len <= maxLen)
    {
        return full;
    }

    // Truncate to 24 characters
    return llGetSubString(full, 0, maxLen - 1);
}

integer CloseMenu()
{
    if (MENU_HANDLE != -1)
    {
        llListenRemove(MENU_HANDLE);
        MENU_HANDLE = -1;
    }
    MENU_CHANNEL = 0;
    MENU_ACTIVE  = FALSE;
    return 0;
}

integer OpenMenu(integer page)
{
    CloseMenu();

    integer total = llGetListLength(gAvKeys);
    if (total == 0)
    {
        if (gHost != NULL_KEY)
        {
            llRegionSayTo(
                gHost,
                0,
                "No avatars within " + (string)INVITE_RANGE_METERS +
                "m to invite."
            );
        }
        return 0;
    }

    gCurrentPage = page;

    MENU_CHANNEL = (integer)((llFrand(1000000.0) * -1.0) - 1.0);
    MENU_HANDLE  = llListen(MENU_CHANNEL, "", gHost, "");
    MENU_ACTIVE  = TRUE;

    integer startIndex = page * NAMES_PER_PAGE;
    integer i          = startIndex;
    integer added      = 0;

    list buttons = [];

    while (i < total && added < NAMES_PER_PAGE)
    {
        string nameLabel = llList2String(gAvNames, i);
        buttons += [nameLabel];
        added++;
        i++;
    }

    // Always include "Everyone"
    buttons += ["Everyone"];

    // If there are more names beyond this page, add paging button
    if (i < total)
    {
        buttons += ["More >>"];
    }

    // Always include Cancel
    buttons += ["Cancel"];

    string title = "Invite to dance ball\n(Page " +
                   (string)(page + 1) + ")";

    llDialog(gHost, title, buttons, MENU_CHANNEL);

    Debug(
        "Opened invite menu page " + (string)page +
        " for " + (string)total + " avatars."
    );
    return 0;
}

integer BuildNearbyList()
{
    gAvKeys      = [];
    gAvNames     = [];
    gAvFullNames = [];

    gHost = llGetOwner();
    if (gHost == NULL_KEY)
    {
        return 0;
    }

    list det = llGetObjectDetails(gHost, [OBJECT_POS]);
    if (llGetListLength(det) < 1)
    {
        return 0;
    }

    vector hostPos = llList2Vector(det, 0);

    list agents = llGetAgentList(AGENT_LIST_REGION, []);
    integer len = llGetListLength(agents);
    integer i   = 0;

    while (i < len)
    {
        key av = llList2Key(agents, i);

        // Skip the host themselves
        if (av != gHost)
        {
            list detAv = llGetObjectDetails(av, [OBJECT_POS]);
            if (llGetListLength(detAv) > 0)
            {
                vector avPos = llList2Vector(detAv, 0);
                float dist   = llVecDist(hostPos, avPos);

                if (dist <= (float)INVITE_RANGE_METERS)
                {
                    string fullName  = FormatName(av);
                    string shortName = FormatNameForButton(av);

                    if (shortName != "")
                    {
                        gAvKeys      += [av];
                        gAvNames     += [shortName];
                        gAvFullNames += [fullName];
                    }
                }
            }
        }

        i++;
    }

    Debug(
        "BuildNearbyList: found " + (string)llGetListLength(gAvKeys) +
        " avatars within " + (string)INVITE_RANGE_METERS + "m."
    );
    return 0;
}

integer SendInviteTo(key target)
{
    if (target == NULL_KEY)
    {
        return 0;
    }

    if (gHostName == "")
    {
        gHostName = FormatName(gHost);
    }

    string msg = "Touch the dance ball nearby " +
                 gHostName + " to dance with them.";

    llRegionSayTo(target, 0, msg);

    return 0;
}

integer SendInviteToIndex(integer idx)
{
    if (idx < 0)
    {
        return 0;
    }

    if (idx >= llGetListLength(gAvKeys))
    {
        return 0;
    }

    key av = llList2Key(gAvKeys, idx);
    SendInviteTo(av);

    if (gHost != NULL_KEY)
    {
        string fullName = llList2String(gAvFullNames, idx);
        llRegionSayTo(
            gHost,
            0,
            "Sent dance-ball invite to " + fullName + "."
        );
    }
    return 0;
}

integer SendInviteToEveryone()
{
    integer len = llGetListLength(gAvKeys);
    integer i   = 0;

    while (i < len)
    {
        key av = llList2Key(gAvKeys, i);
        SendInviteTo(av);
        i++;
    }

    if (gHost != NULL_KEY)
    {
        llRegionSayTo(
            gHost,
            0,
            "Sent dance-ball invite to everyone within " +
            (string)INVITE_RANGE_METERS + "m."
        );
    }
    return 0;
}

// ---------------- State ----------------

default
{
    state_entry()
    {
        gHost     = llGetOwner();
        gHostName = FormatName(gHost);
        CloseMenu();
    }

    on_rez(integer start_param)
    {
        llResetScript();
    }

    changed(integer change)
    {
        if (change & CHANGED_OWNER)
        {
            gHost     = llGetOwner();
            gHostName = FormatName(gHost);
            CloseMenu();
        }
    }

    touch_start(integer total_number)
    {
        // Only the HUD owner can use this button
        key toucher = llDetectedKey(0);
        if (toucher != llGetOwner())
        {
            return;
        }

        gHost     = toucher;
        gHostName = FormatName(gHost);

        BuildNearbyList();

        if (llGetListLength(gAvKeys) == 0)
        {
            llRegionSayTo(
                gHost,
                0,
                "No avatars within " + (string)INVITE_RANGE_METERS +
                "m to invite."
            );
            return;
        }

        OpenMenu(0);
    }

    listen(integer channel, string name, key id, string msg)
    {
        if (!MENU_ACTIVE)
        {
            return;
        }

        if (channel != MENU_CHANNEL)
        {
            return;
        }

        // Only respond to the host's clicks
        if (id != gHost)
        {
            return;
        }

        string choice = llStringTrim(msg, STRING_TRIM);

        if (choice == "Cancel")
        {
            Debug("Invite menu cancelled.");
            CloseMenu();
            return;
        }

        if (choice == "More >>")
        {
            integer total = llGetListLength(gAvKeys);
            integer nextStart =
                (gCurrentPage + 1) * NAMES_PER_PAGE;

            if (nextStart < total)
            {
                OpenMenu(gCurrentPage + 1);
            }
            else
            {
                CloseMenu();
            }
            return;
        }

        if (choice == "Everyone")
        {
            SendInviteToEveryone();
            CloseMenu();
            return;
        }

        // Otherwise, it is one of the name labels
        integer idx = llListFindList(gAvNames, [choice]);
        if (idx != -1)
        {
            SendInviteToIndex(idx);
        }

        CloseMenu();
    }
}
