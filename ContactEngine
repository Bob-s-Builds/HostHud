// -----------------------------------------------------------------------------
// CONTACTENGINE.LSL
// -----------------------------------------------------------------------------
// Receives a list of UUIDs from CORE and opens IMs to those that are ONLINE.
// Also whispers to the HUD owner who was contacted, with clickable IM links.
// If nobody is online (or no valid UUIDs), whispers an error to the HUD owner.
// Respects global debug mode from CORE (LM_DEBUG_MODE).
// -----------------------------------------------------------------------------

integer LM_DUMP_BRIDGE = 1013;
integer LM_CONTACT_ENGINE = 1002;
integer LM_DEBUG_MODE     = 1012;

// Debug state
integer gDebugMode    = FALSE;
key     gDebugOwnerID = NULL_KEY;

// Contact state
key  gHudOwner       = NULL_KEY; // who pressed Manager/Security
list gPendingQueries = [];       // [queryId, targetKey, queryId2, targetKey2, ...]
integer gSentCount   = 0;

integer Debug(string msg)
{
    if (gDebugMode && gDebugOwnerID != NULL_KEY)
    {
        llRegionSayTo(gDebugOwnerID, 0, "[CONTACT DEBUG] " + msg);
    }
    return 0;
}

default
{
    state_entry()
    {
        gPendingQueries = [];
        gSentCount      = 0;
        gHudOwner       = NULL_KEY;
        gDebugMode      = FALSE;
        gDebugOwnerID   = NULL_KEY;
    }

    link_message(integer sender_num, integer num, string msg, key id)
    {
        // Global debug toggle from CORE
        if (num == LM_DEBUG_MODE)
        {
            string s = llToLower(llStringTrim(msg, STRING_TRIM));
            if (s == "on")
            {
                gDebugMode    = TRUE;
                gDebugOwnerID = id;
                Debug("Debug mode ON.");
            }
            else if (s == "off")
            {
                Debug("Debug mode OFF.");
                gDebugMode    = FALSE;
                gDebugOwnerID = id;
            }
            return;
        }

        if (num != LM_CONTACT_ENGINE) return;

        string raw = llStringTrim(msg, STRING_TRIM);
        Debug("Received contact config: '" + raw + "' from " + (string)id);

        if (raw == "")
        {
            if (id != NULL_KEY)
            {
                llRegionSayTo(id, 0,
                    "Sorry, no one is online to be of assistance. Check your venue card has all the right staff.");
            }
            else
            {
                key owner = llGetOwner();
                llRegionSayTo(owner, 0,
                    "Sorry, no one is online to be of assistance. Check your venue card has all the right staff.");
            }
            return;
        }

        // Who pressed the button? If id is NULL_KEY, fall back to HUD owner.
        if (id != NULL_KEY)
        {
            gHudOwner = id;
        }
        else
        {
            gHudOwner = llGetOwner();
        }

        gSentCount      = 0;
        gPendingQueries = [];

        // Allow comma/semicolon separated UUIDs, spaces ignored.
        list tokens = llParseString2List(raw, [",", ";"], [" "]);
        integer len = llGetListLength(tokens);
        integer i;
        integer validCount = 0;

        for (i = 0; i < len; ++i)
        {
            string token = llStringTrim(llList2String(tokens, i), STRING_TRIM);
            if (token != "")
            {
                key targetKey = (key)token;

                // Check well-formed, non-NULL UUID
                if (targetKey != NULL_KEY && (string)targetKey == token)
                {
                    key qid = llRequestAgentData(targetKey, DATA_ONLINE);
                    gPendingQueries += [qid, targetKey];
                    validCount++;
                    Debug("Queued online check for " + (string)targetKey);
                }
                else
                {
                    Debug("Invalid UUID in contact list: '" + token + "'");
                }
            }
        }

        if (validCount == 0)
        {
            if (gHudOwner != NULL_KEY)
            {
                llRegionSayTo(gHudOwner, 0,
                    "Sorry, no one is online to be of assistance. Check your venue card has all the right staff.");
            }
            else
            {
                key owner2 = llGetOwner();
                llRegionSayTo(owner2, 0,
                    "Sorry, no one is online to be of assistance. Check your venue card has all the right staff.");
            }
        }
    }

    dataserver(key query_id, string data)
    {
        integer idx = llListFindList(gPendingQueries, [query_id]);
        if (idx == -1) return;

        key targetKey = llList2Key(gPendingQueries, idx + 1);
        Debug("Online result for " + (string)targetKey + " = '" + data + "'");

        // DATA_ONLINE = "1" if online, "0" if offline
        if (data == "1")
        {
            gSentCount++;

            string hostName = "";
            if (gHudOwner != NULL_KEY)
            {
                hostName = llKey2Name(gHudOwner);
            }

            // Link to open IM to the HUD owner
            string hostLink = "secondlife:///app/agent/" + (string)gHudOwner + "/im";

            string message;
            if (hostName != "")
            {
                message =
                    "Staff on duty are seeking assistance. Please IM " +
                    hostName + " if you are available: " + hostLink;
            }
            else
            {
                message =
                    "Staff on duty are seeking assistance. Please IM the requesting host if you are available.";
            }

            // IM to the manager/security avatar
            llInstantMessage(targetKey, message);

            // Also whisper to the HUD owner with a clickable IM link
            if (gHudOwner != NULL_KEY)
            {
                string targetName = llKey2Name(targetKey);
                if (targetName == "") targetName = "(unknown avatar)";

                string link = "secondlife:///app/agent/" + (string)targetKey + "/im";

                llRegionSayTo(
                    gHudOwner,
                    0,
                    "Contacted " + targetName + ". Click to IM: " + link
                );
            }
        }

        // Remove this (queryId, targetKey) pair
        gPendingQueries = llDeleteSubList(gPendingQueries, idx, idx + 1);

        // If that was the last outstanding query, evaluate result
        if (llGetListLength(gPendingQueries) == 0)
        {
            if (gSentCount == 0)
            {
                if (gHudOwner != NULL_KEY)
                {
                    llRegionSayTo(gHudOwner, 0,
                        "Sorry, no one is online to be of assistance. Check your venue card has all the right staff.");
                }
                else
                {
                    key owner3 = llGetOwner();
                    llRegionSayTo(owner3, 0,
                        "Sorry, no one is online to be of assistance. Check your venue card has all the right staff.");
                }
            }
            else
            {
                Debug("Finished contact pass; IMs sent to " + (string)gSentCount + " avatar(s).");
            }
        }
    }
}
